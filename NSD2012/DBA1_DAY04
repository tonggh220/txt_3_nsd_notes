#######DBA1_DAY04######
一 用户授权
   1.1 用户授权介绍（啥是用户授权）添加用户给客户端连接使用。默认只有root
   能从本机连接MySQL服务。
  
   1.2 用户授权的命令格式？
   ]#mysql -uroot -p密码
   mysql>  grant  权限列表 on 库名  to   用户名@“客户端地址”  
           identified by "密码"  [with grant option] ; 

    权限列表 的表示方式 ：
	         all 		   
             select , insert , update 
			 insert(name),update(age,uid)
			 usage 
	库名的表示方式 ：
			*.*
			库名.* 
			库名.表        
	客户端地址的表示方式 ：	
			localhost
			%
			192.168.4.%
			192.168.4.200
	密码 要符合服务器的密码策略		
	
	with grant option 可选项，让添加的用户可以使用grant命令 再填用户		
	
授权练习
host50]# 添加root用户
mysql> grant all on *.* to root@"192.168.4.51"
       identified by "123qqq...A" with grant option;
	  
	  测试添加的root 用户
host51]# mysql -h192.168.4.50 -uroot -p123qqq...A
mysql> 可以执行所有的sql命令
mysql> grant all on *.*  to mydba@"%" 
identified by "123qqq...A" with grant option;
mysql> exit

测试 添加的mydba用户
[root@host50 ~]# mysql -umydba -p123qqq...A
[root@host51 ~]# mysql -h192.168.4.50  -umydba -p123qqq...A
	
	
	在host50 添加 admin用户 
MySQL> grant  select on  db3.user to admin@"192.168.4.%"
identified by "123qqq...A";

    在51主机测试
host51]# mysql -h192.168.4.50 -uadmin -p123qqq...A
mysql> show databases;
mysql> use db3;
mysql> delete from db3.user; 报错
mysql> select  * from  db3.user; 正确

   在host50 添加 admin2用户
 MySQL> grant  select,insert,update,delete on db1.*  to admin2@"localhost"
 identified by "123qqq...A";
 
   在51主机测试
host51]# mysql -h192.168.4.50 -uadmin2 -p123qqq...A  报错
    
   在50主机测试
host50]# mysql  -uadmin2 -p123qqq...A  成功
mysql> create table db1.t30(id int);  报错
mysql> select  * from db1.t2; 可以

掌握与用户相关的命令：
	查看服务器已有用户
mysql> select host ,user from mysql.user;
	
	查看已有用户的访问权限
mysql> show grants for root@"192.168.4.51";	
	
	程序员把连接用的密码忘记了怎么办(数据库运维重置用户的登录密码)
set password for mydba@"%"=password("密码");	
	
	怎么知道当前连接服务器的用户是谁 select user();
	
	显示当前连接服务器的用户有什么样的访问权限 show grants;
	
	程序怎么修改连接数据库服务器用户的密码
	mysql> set password=password("123qqq...A");

	怎么删除添加的用户
	drop user  mydba@"%" ;
	
   1.3 撤销权限 （库名 和  用户 客户地址  必须和授权时一样 ）
       命令格式  revoke 权限列表 on 库名 from 用户@“客户端地址”；

       
show grants for root@"192.168.4.51"; 查看用户已有的权限

revoke grant option on *.* from root@"192.168.4.51"；只撤销用户的with grant option权限
   
revoke delete on *.* from root@"192.168.4.51"; 撤销用户删除记录的delete权限  
 
revoke all on *.* from root@"192.168.4.51";撤销当前已有的所有权限 

    给已有用户添加新权限？
mysql> grant select on db3.user to yaya@"%" identified by "123qqq...A";
mysql> show grants for yaya@"%";

mysql> grant insert,update(name,gid) on db3.user to yaya@"%";
mysql> show grants for yaya@"%";

mysql> grant grant option on db3.user to yaya@"%";
mysql> show grants for yaya@"%";	

mysql> grant all on db1.* to yaya@"%";


    给用户设置了with grant option 权限后，就能添加用户吗 ？	
	还必须对mysql库下的表有insert 的权限 才可以
    
mysql> grant insert on mysql.* to yaya@"%";
	
在51主机测试	   
host51]# mysql  -h192.168.4.50 -uyaya -p123qqq...A
 mysql> grant select on db3.user to jing@"%" identified by "123qqq...A";
 mysql> grant select on db3.user to yaya1@"localhost" 
    -> identified by "123qqq...A";

在50 查看是否多了新用yaya1
mysql> select host ,user from mysql.user where user="yaya1";

 
   1.4 授权库mysql库的使用

权限列表：
 SELECT, INSERT, UPDATE, delete , CREATE, DROP, RELOAD, 
 SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, 
 SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, 
 LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, 
 CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, 
 CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE

   1.5 root密码管理
操作系统管理员  修改数据库服务器root用户本机登录密码
]# mysqladmin -uroot -p旧密码  password "新密码"
  
]# mysqladmin -uroot -p123qqq...A  password "A...qqq321"

隐藏密码修改
[root@host50 ~]# mysqladmin -uroot -p  password 
Enter password: 旧密码
Enter password: 新密码

破解库管理员root用户本机登录密码，具体操作如下：
			修改数据库服务运行参数
			]# vim /etc/my.cnf
			[mysqld]
            skip-grant-tables
			如果修改了密码策略 要注释掉
			#
			#
			:wq
			
			重启数据库服务
			]# systemctl  restart mysqld
			
			无密码登录 ]#mysql
			修改密码
mysql> update  mysql.user  
set  authentication_string=password("789...qqqA") 
where host="localhost" and user="root";
mysql> flush privileges;

           断开连接mysql> exit
		
			注释修改的运行参数
     ]# vim /etc/my.cnf
			[mysqld]
            #skip-grant-tables
			如果想密码策略 去掉注释掉
			:wq
			
			重启数据库服务
			]# systemctl  restart mysqld			
			
			使用修改的密码登录
			mysql -uroot -p789...qqqA
			
			授权库mysql库的使用
			    存储grant 命令的执行结果
			    查看表记录可以获取用户权限；
				也可以通过更新记录，修改用户权限

user表	记录已有的授权用户及权限    all  *.*
desc mysql.user;   获取表头的名称和具体存储的数据
select user,host from  mysql.user； 获取已经添加用户
show grants for  用户@"客户端" ； 查看详细的权限

db表			记录已有授权用户对数据库的访问权限    db1.*
desc mysql.db;
select host,user,db from mysql.db;
select  * from  mysql.db where  db="db3" \G 
 
tables_priv表	记录已有授权用户对表的访问权限   db1.t20
desc mysql.tables_priv；
select host , user, db , table_name  from  mysql.tables_priv;
select  * from  mysql.tables_priv where table_name="user" \G

columns_priv表	记录已有授权用户对字段的访问权限 insert(name,age) db3.user
desc mysql.	columns_priv;

mysql> grant insert(age),update(password) on db3.user  to jing8@"192.168.4.51"
    -> identified by "123qqq...A";
	
select  * from  mysql.columns_priv;		


二 完全备份
	2.1 相关概念？
		数据备份方式： 
				物理备份  
				逻辑备份
				
		数据备份策略：
			完全备份 备份所有数据（1张表所有记录  一个库的所有表   一台服务的所有库）
	        差异备份 备份完全备份后所有新产生的数据。
	        增量备份  备份上次备份后所有新产生的数据。
			
生产环境使用的备份策略
完全+差异
完全+增量

****单独使用使用完全备份 不合理***

   2.2 对应的具体操作
	   通过物理备份 实现对数据的备份和恢复
	   
	   50 做备份操作
[root@host50 ~]# cp -r /var/lib/mysql  /opt/mysql.bak
[root@host50 ~]# 
[root@host50 ~]# ls /opt/
mysql.bak
	  
[root@host50 ~]# tar -zcvf /opt/mysql.tar.gz /var/lib/mysql/*	  
[root@host50 ~]# scp -r /opt/mysql.bak root@192.168.4.51:/root/
	   

	   
	   51 做恢复操作

			  1 停止数据库服务
			  ]#systemctl  stop  mysqld
			  
			  2 清空本机的数据
			  ]# rm  -rf /var/lib/mysql
		  
			  3 使用备份文件恢复
]# cp  -r /root/mysql.bak   /var/lib/mysql
]# chown  -R mysql:mysql  /var/lib/mysql			  
]# ls /var/lib/mysql/
			   mysql.user   root  localhost
			  4 启动服务  
]#systemctl  start  mysqld			  
			  
	          5 管理员登录查看数据
]# mysql  -uroot 	-p密码 
mysql> show databases;



